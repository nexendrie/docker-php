stages:
- build
- deploy

deploy:php71:
  stage: deploy
  image: docker:latest
  services:
  - docker:dind
  environment:
    name: dockerhub
    url: https://hub.docker.com/r/nexendrie/php/
  before_script:
  - docker login --username $DOCKER_HUB_USERNAME --password $DOCKER_HUB_PASSWORD
  script:
  - docker pull dockette/jessie
  - docker build -t nexendrie/php -f Dockerfile .
  - docker push nexendrie/php:latest
  - docker tag nexendrie/php nexendrie/php:7.1
  - docker push nexendrie/php:7.1
  only:
  - master@nexendrie/docker-php

build:php71:
  stage: build
  image: docker:latest
  script:
  - docker pull dockette/jessie
  - docker build -t nexendrie/php -f Dockerfile .
  except:
  - master@nexendrie/docker-php

pages:
  stage: deploy
  image: nexendrie/php
  environment:
    name: pages
    url: https://nexendrie.gitlab.io/docker-php
  script:
  - phing generate
  cache:
    paths:
    - vendor/
  artifacts:
    paths:
    - public
  only:
  - master@nexendrie/docker-php
