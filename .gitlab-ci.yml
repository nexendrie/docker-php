stages:
- build
- deploy

.job_template: &deploy_job
  stage: deploy

  image: docker:latest

  services:
  - docker:dind

  before_script:
  - docker login --username $DOCKER_HUB_USERNAME --password $DOCKER_HUB_PASSWORD

  script:
  - docker pull dockette/jessie
  - docker build -t nexendrie/php -f $VERSION/Dockerfile $VERSION
  - docker tag nexendrie/php nexendrie/php:$VERSION
  - docker push nexendrie/php:$VERSION

  only:
    - master@nexendrie/docker-php

.job_template: &build_job
  stage: build

  image: docker:latest

  services:
  - docker:dind

  script:
  - docker build -t nexendrie/php -f $VERSION/Dockerfile $VERSION

  except:
    - master@nexendrie/docker-php

deploy:php7.1:
  <<: *deploy_job
  environment:
    name: dockerhub
    url: https://hub.docker.com/r/nexendrie/php/
  after_script:
  - docker push nexendrie/php:latest
  variables:
    VERSION: "7.1"

build:php7.1:
  <<: *build_job
  variables:
    VERSION: "7.1"

deploy:php7.2:
  <<: *deploy_job
  variables:
    VERSION: "7.2"

build:php7.2:
  <<: *build_job
  variables:
    VERSION: "7.2"

pages:
  stage: deploy
  image: nexendrie/php
  environment:
    name: pages
    url: https://nexendrie.gitlab.io/docker-php
  script:
  - phing generate
  cache:
    paths:
    - vendor/
  artifacts:
    paths:
    - public
  only:
  - master@nexendrie/docker-php
